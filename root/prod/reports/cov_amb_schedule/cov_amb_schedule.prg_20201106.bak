/***********************************************************
Author 			:	Dawn Greer, DBA
Date Written	:	10/26/2020
Program Title	:	cov_amb_schedule
Source File		:	cov_amb_schedule.prg
Object Name		:	cov_amb_schedule
Directory		:	cust_script
 
Purpose			: 	Ambulatory Schedules
 
 
Mod		Date		Engineer				Comment
----    ----------- ----------------------- ---------------------------
001		10/26/2020	Dawn Greer, DBA         Original Release - CR 8587
002     10/27/2020  Dawn Greer, DBA			CR 7536 - Add Prompt for
                                            Appt Type and Age.  Add
                                            mobile phone. Add Age2 for
                                            less than or equal to.
003     10/30/2020  Dawn Greer, DBA         Add Appt_Type to the Summary
	                                        Option.  Added a Summary of
	                                        Distinct Patients Options.
*************************************************************************/
drop program cov_amb_schedule go
create program cov_amb_schedule
 
prompt
	"Output to File/Printer/MINE" = "MINE"   ;* Enter or select the printer or file name to send this report to.
	, "Select Facility" = 0
	, "Select Resource" = 0
	, "Select Appt Status" = 0
	, "Select Appt Type" = 0
	, "Age Greater Than Equal To" = 0
	, "Age Less Than Equal To" = 150
	, "Select Appt Begin Date" = "SYSDATE"
	, "Seelct Appt End Date" = "SYSDATE"
	, "Select Summary or Detail" = 0
 
with OUTDEV, FAC, RES, APPTSTATUS, APPTTYPE, AGE, AGE2, BDATE, EDATE, SUMDET
 
FREE RECORD a
RECORD a
(
	1	rec_cnt		=	i4
	1	qual[*]
		2	patient 		=	c100
		2	dob				=	c10
		2   age_as_of_dos   =   i4		;002
		2	home_phone		=	c15
		2	mobile_phone 	=	c15		;002
		2	insurance		=	c50
		2	fin				=	c20
		2	appt_date		=	c25
		2	appt_status		=   c50
		2 	appt_type		=	c50
		2	appt_reminder	=	c50
		2	visit_reason	=	c100
		2	resource		=	c100
		2	facility		=	c100
)
 
 
FREE RECORD totals
RECORD totals
(
	1 rec_cnt = i4
	1 qual[*]
		2 facility 		= c100
		2 resource 		= c100
		2 appt_type     = c50
		2 appt_status 	= c25
		2 total_counts	= i4
)
 
FREE RECORD totalsd		/* Summary Distinct Patient Totals*/  ;003
RECORD totalsd
(
	1 rec_cnt = i4
	1 qual[*]
		2 facility 		= c100
		2 resource 		= c100
		2 appt_type     = c50
		2 appt_status 	= c25
		2 total_counts	= i4
)
 
DECLARE fac_opr_var = c2
DECLARE res_opr_var = c2
DECLARE app_opr_var = c2
DECLARE faclist = c2000
DECLARE facprompt = vc
DECLARE num = i4
DECLARE facitem = vc
DECLARE temp = vc
 
/**********************************************************
Get CMG Facility Data
***********************************************************/
 
SELECT facnum = CNVTSTRING(CV.CODE_VALUE)
FROM CODE_VALUE CV, CODE_VALUE_EXTENSION CVE
WHERE CV.CODE_VALUE = CVE.CODE_VALUE
AND CV.CODE_SET = 220
AND CV.CDF_MEANING = 'AMBULATORY'
AND CV.ACTIVE_IND = 1
AND CVE.FIELD_NAME = 'CMG Reporting'
ORDER BY TRIM(CV.DESCRIPTION,3)
 
HEAD REPORT
	faclist = FILLSTRING(2000,' ')
 	faclist = '('
DETAIL
	faclist = BUILD(BUILD(faclist, facnum), ', ')
 
FOOT REPORT
	faclist = BUILD(faclist,')')
	faclist = REPLACE(faclist,',','',2)
 
WITH nocounter
 
;Facility Prompt
IF(SUBSTRING(1,1,REFLECT(PARAMETER(PARAMETER2($FAC),0))) = "L")		;multiple options selected
	SET fac_opr_var = "IN"
	SET facprompt = '('
	SET num = CNVTINT(SUBSTRING(2,2,REFLECT(PARAMETER(PARAMETER2($FAC),0))))
 
	FOR (i = 1 TO num)
		SET facitem = CNVTSTRING(PARAMETER(PARAMETER2($FAC),i))
		SET facprompt = BUILD(facprompt,facitem)
		IF (i != num)
			SET facprompt = BUILD(facprompt, ",")
		ENDIF
	ENDFOR
	SET facprompt = BUILD(facprompt, ")")
	SET facprompt = BUILD("CV_APPT_RES_ALL_LOC_COV.CODE_VALUE IN ",facprompt)
 
ELSEIF(PARAMETER(PARAMETER2($FAC),1)=0.0)  ;any was selected
	SET fac_opr_var = "IN"
	SET facprompt = BUILD("CV_APPT_RES_ALL_LOC_COV.CODE_VALUE IN ", faclist)
ELSE 	;single value selected
	SET fac_opr_var = "="
	SET facitem = CNVTSTRING(PARAMETER(PARAMETER2($FAC),1))
	SET facprompt = BUILD("CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = ", facitem)
ENDIF
 
;Resource Prompt
IF(SUBSTRING(1,1,REFLECT(PARAMETER(PARAMETER2($RES),0))) = "L")		;multiple options selected
	SET res_opr_var = "IN"
ELSEIF(PARAMETER(PARAMETER2($RES),1)=0.0)  ;any was selected
	SET res_opr_var = "!="
ELSE 	;single value selected
	SET res_opr_var = "="
ENDIF
 
;Appt Status Prompt
IF(SUBSTRING(1,1,REFLECT(PARAMETER(PARAMETER2($APPTSTATUS),0))) = "L")		;multiple options selected
	SET app_opr_var = "IN"
ELSEIF(PARAMETER(PARAMETER2($APPTSTATUS),1)=0.0)  ;any was selected
	SET app_opr_var = "!="
ELSE 	;single value selected
	SET app_opr_var = "="
ENDIF
 
;Appt Type Prompt		;002
IF(SUBSTRING(1,1,REFLECT(PARAMETER(PARAMETER2($APPTTYPE),0))) = "L")		;multiple options selected
	SET appttype_opr_var = "IN"
ELSEIF(PARAMETER(PARAMETER2($APPTTYPE),1)=0.0)  ;any was selected
	SET appttype_opr_var = "!="
ELSE 	;single value selected
	SET appttype_opr_var = "="
ENDIF
 
/**********************************************************
Get Schedule Data
***********************************************************/
 
SELECT DISTINCT
  PATIENT = PERSON.NAME_FULL_FORMATTED
  ,DOB = FORMAT(CNVTDATETIMEUTC(PERSON.BIRTH_DT_TM,1),"MM/DD/YYYY;;d")
  ,AGE_AS_OF_DOS = FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365))	;002
  ,HOME_PHONE = EVALUATE2(IF (SIZE(TRIM(PHONE.PHONE_NUM,3)) = 10)
  		CONCAT("(",SUBSTRING(1,3,PHONE.PHONE_NUM),")",SUBSTRING(4,3,PHONE.PHONE_NUM),"-",SUBSTRING(7,4,PHONE.PHONE_NUM))
  		ELSE " " ENDIF)
  ,MOBILE_PHONE = EVALUATE2(IF (SIZE(TRIM(MPHONE.PHONE_NUM,3)) = 10)
  		CONCAT("(",SUBSTRING(1,3,MPHONE.PHONE_NUM),")",SUBSTRING(4,3,MPHONE.PHONE_NUM),"-",SUBSTRING(7,4,MPHONE.PHONE_NUM))
  		ELSE " " ENDIF)  ;002
  ,INSURANCE = ORGANIZATION_PRIM.ORG_NAME
  ,FIN = ENCNTR_ALIAS.ALIAS
  ,APPT_DATE = FORMAT(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, "MM/DD/YYYY hh:mm:ss")
  ,APPT_STATUS = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.SCH_STATE_CD)
  ,APPT_TYPE = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.APPT_TYPE_CD)
  ,APPT_REMINDER = SCH_EVENT_DETAIL.OE_FIELD_DISPLAY_VALUE
  ,VISIT_REASON = APPT_SCH_EVENT.APPT_REASON_FREE
  ,RESOURCE = APPT_RES_RES_CD_ALL.DESCRIPTION
  ,FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID	;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
	))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
	'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
 
HEAD REPORT
	cnt = 0
	CALL alterlist(a->qual, 10)
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(a->qual, cnt + 9)
	ENDIF
 
	a->qual[cnt].patient 		= 	patient
	a->qual[cnt].dob			= 	FORMAT(dob, "MM/DD/YYYY")
	a->qual[cnt].age_as_of_dos  =   AGE_AS_OF_DOS		;002
	a->qual[cnt].home_phone	 	=	home_phone
	a->qual[cnt].mobile_phone	=	mobile_phone		;002
	a->qual[cnt].insurance		=	insurance
	a->qual[cnt].fin			= 	fin
	a->qual[cnt].appt_date		=	appt_date,
	a->qual[cnt].appt_status	=	appt_status
	a->qual[cnt].appt_type		=	appt_type
	a->qual[cnt].appt_reminder	=	appt_reminder
	a->qual[cnt].visit_reason	=	visit_reason
	a->qual[cnt].resource		=	resource
	a->qual[cnt].facility		=	facility
 
FOOT REPORT
	stat = alterlist(a->qual, cnt )
	a->rec_cnt = cnt
WITH nocounter
 
/*********************************************************************
	Summary
**********************************************************************/
/*Appt Status Totals*/
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,RESOURCE = APPT_RES_RES_CD_ALL.DESCRIPTION
    ,APPT_TYPE = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.APPT_TYPE_CD)
	,APPT_STATUS = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.SCH_STATE_CD)
	,TOTAL_COUNTS = COUNT(*)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID		;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)		;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
	'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION, APPT_RES_RES_CD_ALL.DESCRIPTION, APPT_SCH_EVENT.APPT_TYPE_CD,
APPT_SCH_EVENT.SCH_STATE_CD
 
 
HEAD REPORT
	cnt = 0
	CALL alterlist(totals->qual, 10)
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totals->qual, cnt + 9)
	ENDIF
 
	totals->qual[cnt].facility 		= 	facility
	totals->qual[cnt].resource		= 	resource
	totals->qual[cnt].appt_type     =   appt_type
	totals->qual[cnt].appt_status 	=	appt_status
	totals->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totals->qual, cnt)
	totals->rec_cnt	= cnt
WITH nocounter
 
/*Appt Type Totals*/	;003
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,RESOURCE = APPT_RES_RES_CD_ALL.DESCRIPTION
    ,APPT_TYPE = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.APPT_TYPE_CD)
	,TOTAL_COUNTS = COUNT(*)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID		;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)		;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
	'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION, APPT_RES_RES_CD_ALL.DESCRIPTION, APPT_SCH_EVENT.APPT_TYPE_CD
 
 
HEAD REPORT
	cnt = totals->rec_cnt
 
 	IF(mod(cnt,10)> 0)
   		CALL alterlist(totals->qual, cnt + (10-mod(cnt,10)))
	ENDIF
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totals->qual, cnt + 9)
	ENDIF
 
	totals->qual[cnt].facility 		= 	facility
	totals->qual[cnt].resource		= 	resource
	totals->qual[cnt].appt_type     =   appt_type
	totals->qual[cnt].appt_status 	=	"Totals"
	totals->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totals->qual, cnt)
	totals->rec_cnt	= cnt
WITH nocounter
 
/* Resource Totals */
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,RESOURCE = APPT_RES_RES_CD_ALL.DESCRIPTION
	,TOTAL_COUNTS = COUNT(*)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID	;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
	'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION, APPT_RES_RES_CD_ALL.DESCRIPTION
 
 
HEAD REPORT
	cnt = totals->rec_cnt
 
 	IF(mod(cnt,10)> 0)
   		CALL alterlist(totals->qual, cnt + (10-mod(cnt,10)))
	ENDIF
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totals->qual, cnt + 9)
	ENDIF
 
	totals->qual[cnt].facility 		= 	facility
	totals->qual[cnt].resource		= 	resource
	totals->qual[cnt].appt_type     =   "zzzTotals"
	totals->qual[cnt].appt_status 	=	"Resource Totals"
	totals->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totals->qual, cnt)
	totals->rec_cnt	= cnt
WITH nocounter
 
/* Facility Totals */
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,TOTAL_COUNTS = COUNT(*)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID	;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
 
 
HEAD REPORT
	cnt = totals->rec_cnt
	IF(mod(cnt,10)> 0)
   		CALL alterlist(totals->qual, cnt + (10-mod(cnt,10)))
	ENDIF
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totals->qual, cnt + 9)
	ENDIF
 
	totals->qual[cnt].facility 		= 	facility
	totals->qual[cnt].resource		= 	"zzzTotals"
	totals->qual[cnt].appt_type     =   "zzzTotals"
	totals->qual[cnt].appt_status 	=	"Facility Totals"
	totals->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totals->qual, cnt)
	totals->rec_cnt	= cnt
WITH nocounter
 
/*********************************************************************
	Summary Distinct Patients	;003
**********************************************************************/
/*Appt Status Totals*/
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,RESOURCE = APPT_RES_RES_CD_ALL.DESCRIPTION
    ,APPT_TYPE = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.APPT_TYPE_CD)
	,APPT_STATUS = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.SCH_STATE_CD)
	,TOTAL_COUNTS = COUNT(DISTINCT PERSON.PERSON_ID)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID		;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)		;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
	'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION, APPT_RES_RES_CD_ALL.DESCRIPTION, APPT_SCH_EVENT.APPT_TYPE_CD,
APPT_SCH_EVENT.SCH_STATE_CD
 
 
HEAD REPORT
	cnt = 0
	CALL alterlist(totalsd->qual, 10)
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totalsd->qual, cnt + 9)
	ENDIF
 
	totalsd->qual[cnt].facility 	= 	facility
	totalsd->qual[cnt].resource		= 	resource
	totalsd->qual[cnt].appt_type    =   appt_type
	totalsd->qual[cnt].appt_status 	=	appt_status
	totalsd->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totalsd->qual, cnt)
	totalsd->rec_cnt	= cnt
WITH nocounter
 
/*Appt Type Totals*/
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,RESOURCE = APPT_RES_RES_CD_ALL.DESCRIPTION
    ,APPT_TYPE = UAR_GET_CODE_DISPLAY(APPT_SCH_EVENT.APPT_TYPE_CD)
	,TOTAL_COUNTS = COUNT(DISTINCT PERSON.PERSON_ID)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID		;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)		;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
	'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION, APPT_RES_RES_CD_ALL.DESCRIPTION, APPT_SCH_EVENT.APPT_TYPE_CD
 
 
HEAD REPORT
	cnt = totalsd->rec_cnt
 
 	IF(mod(cnt,10)> 0)
   		CALL alterlist(totalsd->qual, cnt + (10-mod(cnt,10)))
	ENDIF
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totalsd->qual, cnt + 9)
	ENDIF
 
	totalsd->qual[cnt].facility 	= 	facility
	totalsd->qual[cnt].resource		= 	resource
	totalsd->qual[cnt].appt_type    =   appt_type
	totalsd->qual[cnt].appt_status 	=	"Totals"
	totalsd->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totalsd->qual, cnt)
	totalsd->rec_cnt	= cnt
WITH nocounter
 
/* Resource Totals */
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,RESOURCE = APPT_RES_RES_CD_ALL.DESCRIPTION
	,TOTAL_COUNTS = COUNT(DISTINCT PERSON.PERSON_ID)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID	;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
	'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION, APPT_RES_RES_CD_ALL.DESCRIPTION
 
 
HEAD REPORT
	cnt = totalsd->rec_cnt
 
 	IF(mod(cnt,10)> 0)
   		CALL alterlist(totalsd->qual, cnt + (10-mod(cnt,10)))
	ENDIF
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totalsd->qual, cnt + 9)
	ENDIF
 
	totalsd->qual[cnt].facility 	= 	facility
	totalsd->qual[cnt].resource		= 	resource
	totalsd->qual[cnt].appt_type    =   "zzzTotals"
	totalsd->qual[cnt].appt_status 	=	"Resource Totals"
	totalsd->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totalsd->qual, cnt)
	totalsd->rec_cnt	= cnt
WITH nocounter
 
/* Facility Totals */
SELECT
	FACILITY = CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
	,TOTAL_COUNTS = COUNT(DISTINCT PERSON.PERSON_ID)
FROM PERSON
  , (LEFT JOIN PHONE ON (PERSON.PERSON_ID = PHONE.PARENT_ENTITY_ID
  		AND PHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND PHONE.ACTIVE_IND = 1
  		AND PHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND PHONE.PHONE_TYPE_CD = 170 /*Home Phone*/
  		AND PHONE.PHONE_TYPE_SEQ = 1
  		AND PHONE.PHONE_NUM_KEY != ' '
  	))
  , (LEFT JOIN PHONE MPHONE ON (PERSON.PERSON_ID = MPHONE.PARENT_ENTITY_ID	;002
  		AND MPHONE.PARENT_ENTITY_NAME = 'PERSON'
  		AND MPHONE.ACTIVE_IND = 1
  		AND MPHONE.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  		AND MPHONE.PHONE_TYPE_CD = 4149712.00 /*Mobile Phone*/
  		AND MPHONE.PHONE_TYPE_SEQ = 1
  		AND MPHONE.PHONE_NUM_KEY != ' '
  	))
  , (INNER JOIN ENCOUNTER ON (ENCOUNTER.PERSON_ID=PERSON.PERSON_ID
  		AND ENCOUNTER.ACTIVE_IND = 1
  	))
  , (INNER JOIN ENCNTR_ALIAS ON (ENCNTR_ALIAS.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
		AND ENCNTR_ALIAS.ACTIVE_IND = 1
		AND ENCNTR_ALIAS.END_EFFECTIVE_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
		AND ENCNTR_ALIAS.ENCNTR_ALIAS_TYPE_CD = 1077  /*FIN NBR*/
	))
  , (LEFT JOIN ENCNTR_PLAN_RELTN ENCNTR_PLAN_RELTN2 ON (ENCOUNTER.ENCNTR_ID=ENCNTR_PLAN_RELTN2.ENCNTR_ID
  		AND ENCNTR_PLAN_RELTN2.PRIORITY_SEQ = 1
  		AND ENCNTR_PLAN_RELTN2.ACTIVE_IND = 1
  	))
  , (LEFT JOIN ORGANIZATION ORGANIZATION_PRIM ON (ORGANIZATION_PRIM.ORGANIZATION_ID=ENCNTR_PLAN_RELTN2.ORGANIZATION_ID
  	))
  , (INNER JOIN SCH_APPT APPT_SCH_APPT ON (APPT_SCH_APPT.ENCNTR_ID=ENCOUNTER.ENCNTR_ID
  		AND APPT_SCH_APPT.ROLE_MEANING = "PATIENT"
  		AND APPT_SCH_APPT.STATE_MEANING != "RESCHEDULED"
  	))
  , (INNER JOIN SCH_EVENT APPT_SCH_EVENT ON (APPT_SCH_EVENT.SCH_EVENT_ID=APPT_SCH_APPT.SCH_EVENT_ID
    ))
  , (LEFT JOIN SCH_EVENT_DETAIL SCH_EVENT_DETAIL ON (SCH_EVENT_DETAIL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  		AND SCH_EVENT_DETAIL.OE_FIELD_ID = 23372832 /*Patient Reminder*/
  		AND SCH_EVENT_DETAIL.VERSION_DT_TM > CNVTDATETIME(CURDATE,CURTIME3)
  	))
  , (LEFT JOIN SCH_APPT APPT_SCH_RES_APPT_ALL ON (APPT_SCH_RES_APPT_ALL.SCH_EVENT_ID = APPT_SCH_EVENT.SCH_EVENT_ID
  	))
  , (LEFT JOIN SCH_RESOURCE APPT_SCH_RESOURCE_ALL ON (APPT_SCH_RES_APPT_ALL.RESOURCE_CD=APPT_SCH_RESOURCE_ALL.RESOURCE_CD
    ))
  , (LEFT JOIN CODE_VALUE APPT_RES_RES_CD_ALL ON (APPT_SCH_RESOURCE_ALL.RESOURCE_CD=APPT_RES_RES_CD_ALL.CODE_VALUE
  		AND APPT_RES_RES_CD_ALL.CODE_SET = 14231
  	))
  , (LEFT JOIN CODE_VALUE CV_APPT_RES_ALL_LOC_COV ON (APPT_SCH_RES_APPT_ALL.APPT_LOCATION_CD=CV_APPT_RES_ALL_LOC_COV.CODE_VALUE
  		AND CV_APPT_RES_ALL_LOC_COV.CODE_SET = 220
		AND CV_APPT_RES_ALL_LOC_COV.CDF_MEANING IN ("AMBULATORY")
    ))
  , (LEFT JOIN CODE_VALUE_EXTENSION CVE ON (CV_APPT_RES_ALL_LOC_COV.CODE_VALUE = CVE.CODE_VALUE
		AND CVE.FIELD_NAME = 'CMG Reporting'
    ))
WHERE PERSON.ACTIVE_IND = 1
AND PARSER(facprompt)
AND OPERATOR(APPT_RES_RES_CD_ALL.CODE_VALUE, res_opr_var, $RES)
AND OPERATOR(APPT_SCH_EVENT.SCH_STATE_CD, app_opr_var, $APPTSTATUS)
AND OPERATOR(APPT_SCH_EVENT.APPT_TYPE_CD, appttype_opr_var, $APPTTYPE)	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) >= $AGE	;002
AND FLOOR((DATETIMEDIFF(APPT_SCH_RES_APPT_ALL.BEG_DT_TM, PERSON.BIRTH_DT_TM)/365)) <= $AGE2	;002
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY IS NOT NULL
AND APPT_SCH_RESOURCE_ALL.MNEMONIC_KEY != ' '
AND APPT_SCH_RES_APPT_ALL.SLOT_STATE_CD IN (0,9541)
AND PERSON.NAME_LAST_KEY NOT IN ('FFFFPEDS','FFFFAMB','FFFFPNRC','FFFFOP','FFFFED','FFFFIP','FFFFWH','FFFFTEST','FFFFREVCYCLE',
'FFFFPHARM','ZZGLOVER','ZZTEST','ZZWICK','ZZBOGUS','ZZZZTESTPW','ZZZREGRESSION','ZZZZBHTEST','ZZZNEUROPW','ZZZFLMCRAD','ZZZFSRRAD',
	'ZZZTESTONE','ZZZAMB','ZZZPWRAD','ZZTOPTEST','ZZZ','ZZZRMCRAD','ZZZZTESTPBH','ZZMDDONOTUSE','ZZZMPITESTP','ZZZRADTEST','ZZZFSRGO',
	'ZZZFSWRAD','ZZZTESTIP','ZZZTEST','ZZELLMER','ZZZMPITESTBL','ZZZZTESTPOC','ZZZZZZTEST','ZZZTESTOP','TTTTTEST','TTTTGENLAB','TTTT',
	'TTTTMAYO','TTTTPHARMTEST','TTTTESTFSV','TTTTONC','TTTTESTCATHLAB','TTURNER','TTEST','TTTTHUDLOW','TTTTTESTFN','TTTTCAMCAPTEST',
	'TTTTMDI','TTBACKLOADING','TTTTESTPRVL','TTTTMMC','TTTTQUEST','TTHOMASON','TTTTPRINTER','TTTTEST')
AND APPT_SCH_RES_APPT_ALL.BEG_DT_TM BETWEEN CNVTDATETIME($bdate) AND CNVTDATETIME($edate)
GROUP BY CV_APPT_RES_ALL_LOC_COV.DESCRIPTION
 
 
HEAD REPORT
	cnt = totalsd->rec_cnt
	IF(mod(cnt,10)> 0)
   		CALL alterlist(totalsd->qual, cnt + (10-mod(cnt,10)))
	ENDIF
 
DETAIL
	cnt = cnt + 1
	IF (mod(cnt,10) = 1 OR cnt = 1)
		stat = alterlist(totalsd->qual, cnt + 9)
	ENDIF
 
	totalsd->qual[cnt].facility 	= 	facility
	totalsd->qual[cnt].resource		= 	"zzzTotals"
	totalsd->qual[cnt].appt_type    =   "zzzTotals"
	totalsd->qual[cnt].appt_status 	=	"Facility Totals"
	totalsd->qual[cnt].total_counts	=	total_counts
 
FOOT REPORT
	stat = alterlist(totalsd->qual, cnt)
	totalsd->rec_cnt	= cnt
WITH nocounter
 
 
/***************************************************************************
	Output Detail Report or Summary Report
****************************************************************************/
 
IF($sumdet = 0)	;Summary Report
 
	SELECT INTO $outdev
 		dateRange = BUILD2(FORMAT(CNVTDATETIME($bdate),"mm/dd/yyyy hh:mm;;q"), ' - ',
		FORMAT(CNVTDATETIME($edate), "mm/dd/yyyy hh:mm;;q")),
		Facility = totals->qual[d.seq].facility,
		Resource = totals->qual[d.seq].resource,
		Appt_Type = totals->qual[d.seq].appt_type,
		Appt_Status = totals->qual[d.seq].appt_status,
		Totals_Counts = totals->qual[d.seq].total_counts
 	FROM (dummyt d with seq = totals->rec_cnt)
 	ORDER BY Facility, Resource, Appt_Type, Appt_Status
	WITH nocounter, format, separator = ' '
 
ELSEIF ($sumdet = 1) ;Summary Distinct Patients
 
	SELECT INTO $outdev
 		dateRange = BUILD2(FORMAT(CNVTDATETIME($bdate),"mm/dd/yyyy hh:mm;;q"), ' - ',
		FORMAT(CNVTDATETIME($edate), "mm/dd/yyyy hh:mm;;q"), ' - Distinct Patients'),
		Facility = totalsd->qual[d.seq].facility,
		Resource = totalsd->qual[d.seq].resource,
		Appt_Type = totalsd->qual[d.seq].appt_type,
		Appt_Status = totalsd->qual[d.seq].appt_status,
		Totals_Counts = totalsd->qual[d.seq].total_counts
 	FROM (dummyt d with seq = totalsd->rec_cnt)
 	ORDER BY Facility, Resource, Appt_Type, Appt_Status
	WITH nocounter, format, separator = ' '
 
ELSE		;Detail Report
	SELECT INTO $outdev
		Patient = a->qual[d.seq].patient,
		DOB = a->qual[d.seq].DOB,
		Age_As_of_DOS = a->qual[d.seq].age_as_of_dos,		;002
		Home_Phone = a->qual[d.seq].home_phone,
		Mobile_Phone = a->qual[d.seq].mobile_phone,		;002
		Insurance = a->qual[d.seq].insurance,
		Fin = a->qual[d.seq].fin,
		Appt_Date = a->qual[d.seq].appt_date,
		Appt_Status = a->qual[d.seq].appt_status,
		Appt_Type = a->qual[d.seq].appt_type,
		Appt_Reminder = a->qual[d.seq].appt_reminder,
		Visit_Reason = a->qual[d.seq].visit_reason,
		Resource = a->qual[d.seq].resource,
		Facility = a->qual[d.seq].facility
	FROM (dummyt d WITH seq = a->rec_cnt)
	ORDER BY Facility, Resource, Appt_Date, Patient, Appt_Type, Appt_Status
	WITH nocounter, format, separator = ' '
ENDIF
 
;CALL ECHORECORD(a)
;CALL ECHORECORD(totals)
 
GO TO exitscript
#exitscript
 
END
GO
 
 
